# プロトコル仕様

- **物理層**: Raspberry Pi Pico の USB CDC-ACM(USB シリアル)。
- **フレーミング**: 「ASCII 文字列 + LF(`\n`)」の 1 行を 1 コマンド/レスポンスとする。
- **エンコーディング**: UTF-8 (英数字と記号を主に想定)。
- **大文字/小文字**:
  - **関数名**: GrovePi C++ API の名前をそのまま使う (`pinMode`, `digitalRead` など)。大文字・小文字は区別しない。
  - **引数**: `INPUT`/`OUTPUT`/`HIGH`/`LOW` などのキーワードも、大文字・小文字は区別しない。
- **エコーバック**: ファームウェアは受信文字を一切エコーバックしない。  

## 物理層・ホスト側シリアル設定

- インタフェース: USB CDC-ACM(Pico 標準の USB シリアル)。
- ホスト側の推奨設定
  - ボーレート: `115200` (CDC では実質意味を持たないが、慣習的に設定)
  - データビット: 8
  - パリティ: none
  - ストップビット: 1
  - フロー制御: none
- 改行文字は LF(`\n`) を使用すること。

## Grove ピン番号と Pico 実ピンの対応

ここでは **Grove shield のシルク表記** をそのまま C++ API のピン番号として扱う。

### アナログピン

| Grove shield シルク | C++ で指定するピン番号 | Pico 側 ADC / GPIO |
|---------------------|------------------------|--------------------|
| A0                  | `0`                    | `ADC(0)` / GP26    |
| A1                  | `1`                    | `ADC(1)` / GP27    |
| A2                  | `2`                    | `ADC(2)` / GP28    |

### デジタルピン

| Grove shield シルク | C++ で指定するピン番号 | Pico 側 GPIO |
|---------------------|------------------------|--------------|
| D16                 | `16`                   | GP16         |
| D18                 | `18`                   | GP18         |
| D20                 | `20`                   | GP20         |

> 例: C++ 側で `pinMode(16, OUTPUT)` と書けば、Grove shield 上の D16 ピンに接続されたデバイスが出力として動作する。

## 基本コマンド

### `pinMode` — デジタルピン方向設定

**リクエスト**

```text
pinMode(<pin>, <mode>)
```

- `<pin>`: 整数。上記のデジタルピン番号 (`16`/`18`/`20` など)。
- `<mode>`: 以下のいずれか (大文字・小文字は区別しない)
  - `INPUT`, `IN`
  - `OUTPUT`, `OUT`

**レスポンス**

- 成功時: 空行 (改行のみ)。
- 失敗時: `error`。

アナログピン (`A0/A1/A2` = `0/1/2`) に対して `pinMode` を呼んだ場合は、**何もしないが成功扱い (空行)** とする。

### `digitalWrite` — デジタル出力

**リクエスト**

```text
digitalWrite(<pin>, <value>)
```

- `<pin>`: 整数。上記のデジタルピン番号 (`16`/`18`/`20` など)。
- `<value>`: 以下のいずれか (大文字・小文字は区別しない)
  - `LOW`
  - `HIGH`

**レスポンス**

- 成功時: 空行 (改行のみ)。
- 失敗時: `error`。

実装側では、自動的に対象ピンを **出力モードに初期化** してから値を設定する。

### `digitalRead` — デジタル入力

**リクエスト**

```text
digitalRead(<pin>)
```

- `<pin>`: 整数。上記のデジタルピン番号 (`16`/`18`/`20` など)。

**レスポンス**

- 成功時: `0` または `1` を表す 10 進整数文字列 1 行。
- 失敗時: `error`。

実装側では、自動的に対象ピンを **入力モードに初期化** してから値を読み取る。

### `analogRead` — アナログ入力 (A0/A1/A2)

**リクエスト**

```text
analogRead(<pin>)
```

- `<pin>`: 整数。アナログピン番号 (`0`/`1`/`2`)。  
  Grove shield シルクではそれぞれ `A0`/`A1`/`A2` に対応する。

**レスポンス**

- 成功時: `0〜65535` の範囲の 10 進整数文字列 1 行。
  - Pico の `ADC.read_u16()` の生値に対応。
- 失敗時: `error`。

GrovePi C++ ライブラリ側では、この 16bit 値を **簡易的に 10bit 相当 (0〜1023 程度)** にスケールダウンして返すようにしている。

### `analogWrite` — PWM 出力

**リクエスト**

```text
analogWrite(<pin>, <value>)
```

- `<pin>`: 整数。デジタルピン番号 (`16`/`18`/`20` など)。
- `<value>`: `0〜255` の整数値。
  - 0 で完全 OFF、255 で最大デューティ (約 100%)。

**レスポンス**

- 成功時: 空行 (改行のみ)。
- 失敗時: `error`。

Pico 側では、指定ピンに対して PWM を初期化し、`value` を 0〜65535 のデューティ値に線形マッピングして出力する。

### `ultrasonicRead` — 超音波距離センサー読み取り

**リクエスト**

```text
ultrasonicRead(<pin>)
```

- `<pin>`: 整数。超音波距離センサー(Grove - Ultrasonic Ranger 等) を接続したデジタルピン番号 (`16`/`18`/`20` など)。

**レスポンス**

- 成功時: センサーから取得した距離 [cm] を表す 10 進整数文字列 1 行。
- 失敗時: `error`。

Pico 側では、指定ピンをトリガ兼エコー端子として使用し、一定時間のパルス幅から距離を算出する。

タイムアウトや異常値を検出した場合は `error` を返す。

## LCD 表示用コマンド

Dexter Industries の Grove RGB LCD 用 C++ サンプル(`grove_rgb_lcd.*`)で提供されている  
`LCD::setText` / `LCD::setRGB` の機能を、Pico + Grove Shield 構成向けに  
シリアルプロトコルとして表現したものである。

### `setText` / `setRGB` — LCD 表示・色設定

#### `setText` — 文字列表示

**リクエスト**

```text
setText(<bus>, <文字列...>)
```

- `<bus>`: I2C バス番号を表す整数または識別子
  - `0` または `i2c0`
  - `1` または `i2c1`
- `<文字列...>`: 表示したいテキスト。
  - テキストは 16x2 を想定し、**先頭 16 文字が 1 行目, 17〜32 文字目が 2 行目**。それ以降は切り捨て。

**レスポンス**

- 成功時: 空行(改行のみ)。
- 失敗時: `error`。

#### `setRGB` — バックライト色設定

**リクエスト**

```text
setRGB(<bus>, <r>, <g>, <b>)
```

- `<bus>`: I2C バス番号 (`0`/`1`/`i2c0`/`i2c1`)。
- `<r>`, `<g>`, `<b>`: それぞれ `0〜255` の整数値。

**レスポンス**

- 成功時: 空行(改行のみ)。
- 失敗時: `error`。

## DHT 温湿度センサー用コマンド

### `dhtRead` — 温度[℃]・湿度[%]の読み取り

**リクエスト**

```text
dhtRead(<pin>, <module_type>)
```

- `<pin>`: 整数。DHT センサーを接続したデジタルピン番号 (`16`/`18`/`20` など)。
- `<module_type>`: DHT モジュール種別を表す整数。
  - `0` : BLUE モジュール (DHT11 相当)
  - `1` : WHITE モジュール (DHT22 など)

**レスポンス**

- 成功時:  

```text
<temp_C> <humidity_percent>
```

  - 例: `23.4 56.7`
  - いずれも 10 進小数表現の文字列。
- 失敗時: `error`。

Pico 側では、指定ピンを DHT 用に初期化し、1 回の計測で温度と湿度を取得して返す。  
ホスト C++ 側 (`grovepi.cpp`) では、この結果を `float` にパースして `dhtRead(pin, module_type, temp, humidity)` として提供する。

## GrovePi C++ ライブラリとの対応関係

上記プロトコルと C++ API (`grovepi.h`) の対応は、基本的に **関数名 + 引数をそのまま文字列化**したものになる。

| GrovePi C++ API                          | シリアルプロトコル例                         |
|-----------------------------------------|----------------------------------------------|
| `pinMode(16, OUTPUT)`                   | `pinMode(16, OUTPUT)`                        |
| `pinMode(18, INPUT)`                    | `pinMode(18, INPUT)`                         |
| `digitalWrite(20, HIGH)`                | `digitalWrite(20, HIGH)`                     |
| `digitalWrite(18, LOW)`                 | `digitalWrite(18, LOW)`                      |
| `digitalRead(16)`                       | `digitalRead(16)`                            |
| `analogRead(0)`                         | `analogRead(0)`                              |
| `analogWrite(20, 128)`                  | `analogWrite(20, 128)`                       |
| `ultrasonicRead(16)`                    | `ultrasonicRead(16)`                         |
| `setText(1, \"Hello\")`                | `setText(1, Hello)`                          |
| `setRGB(1, 0, 255, 0)`                  | `setRGB(1, 0, 255, 0)`                       |
| `dhtRead(16, 0, temp, hum)` ※          | `dhtRead(16, 0)`                             |

※ C++ 側では `dhtRead(uint8_t pin, uint8_t module_type, float &temp, float &humidity)` というシグネチャで、  
内部的に `dhtRead(pin, module_type)` コマンドを Pico に送信し、`temp humidity` の 2 つの数値を受け取っている。

C++ 実装 (`grovepi.cpp`) は、これらの文字列をそのまま USB シリアルに流し、
Pico 側 `main.py` がそのまま同名コマンドとして解釈・実行する構造になっている。

